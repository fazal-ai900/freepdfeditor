<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Free online PDF editor to edit, annotate, resize, choose fonts, remove selected text, and download PDFs without sign-up.">
  <meta name="keywords" content="free PDF editor, edit PDF online, PDF annotator, resize PDF, custom fonts, remove selected text">
  <title>Free PDF Editor - Edit PDFs Online</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAHUlEQVR42mNgwA3Y8eLF/4zMzMzMzMzMzMzMzMzM7ABVvAmL4Z2ZkwAAAABJRU5ErkJggg==">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    #canvas-container { 
      border: 1px solid #ccc; 
      background: #fff; 
      margin-top: 20px; 
      max-width: 100%; 
      min-height: 400px; 
      position: relative; 
    }
    #pdf-canvas { 
      display: block; 
      max-width: 100%; 
      height: auto; 
    }
    .toolbar { margin-bottom: 20px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container my-4">
    <h1 class="text-center mb-4">Free PDF Editor</h1>
    <div class="toolbar">
      <input type="file" id="pdf-upload" accept="application/pdf" class="btn btn-outline-primary me-2" aria-label="Upload PDF">
      <button id="remove-selected-text-btn" class="btn btn-danger me-2" disabled>Remove Selected Text</button>
      <button id="add-text-btn" class="btn btn-primary me-2" disabled>Add Text</button>
      <select id="font-select" class="form-select d-inline-block w-auto me-2" disabled aria-label="Select Font">
        <option value="Helvetica">Helvetica</option>
        <option value="Times-Roman">Times Roman</option>
        <option value="Courier">Courier</option>
      </select>
      <input type="number" id="font-size" class="form-control d-inline-block w-auto me-2" value="16" min="8" max="72" disabled aria-label="Font Size">
      <select id="page-size" class="form-select d-inline-block w-auto me-2" disabled aria-label="Select Page Size">
        <option value="A4">A4</option>
        <option value="A3">A3</option>
        <option value="Letter">Letter</option>
        <option value="Legal">Legal</option>
      </select>
      <button id="download-btn" class="btn btn-success" disabled>Download PDF</button>
    </div>
    <div id="canvas-container">
      <canvas id="pdf-canvas"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.mjs" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.0/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import * as pdfjsLib from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.min.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.7.76/build/pdf.worker.min.mjs';

    let pdfDoc = null;
    let pdfBytes = null;
    let currentPageNum = 1;
    let fabricCanvas = null;
    let scale = 1.0;

    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const pdfUpload = document.getElementById('pdf-upload');
    const removeSelectedTextBtn = document.getElementById('remove-selected-text-btn');
    const addTextBtn = document.getElementById('add-text-btn');
    const fontSelect = document.getElementById('font-select');
    const fontSizeInput = document.getElementById('font-size');
    const pageSizeSelect = document.getElementById('page-size');
    const downloadBtn = document.getElementById('download-btn');
    const canvasContainer = document.getElementById('canvas-container');

    // Draw placeholder text if no PDF is loaded
    function drawPlaceholder() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#888';
      ctx.font = '20px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('No PDF loaded. Upload a PDF to start.', canvas.width / 2, canvas.height / 2);
    }

    // Initialize canvas with placeholder
    canvas.width = canvasContainer.clientWidth;
    canvas.height = 400;
    drawPlaceholder();

    // Initialize Fabric.js canvas
    fabricCanvas = new fabric.Canvas('pdf-canvas', { 
      preserveObjectStacking: true,
      backgroundColor: null
    });

    // Page size dimensions (in points, 1 point = 1/72 inch)
    const pageSizes = {
      A4: [595, 842],
      A3: [842, 1190],
      Letter: [612, 792],
      Legal: [612, 1008]
    };

    // Load and render PDF
    async function loadPDF(file) {
      try {
        if (!file || file.type !== 'application/pdf') {
          throw new Error('Invalid file. Please upload a PDF.');
        }
        console.log('Loading PDF:', file.name, `Size: ${file.size} bytes`);
        const arrayBuffer = await file.arrayBuffer();
        pdfBytes = arrayBuffer;
        pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        console.log('PDF loaded successfully:', pdfDoc.numPages, 'pages');
        enableControls();
        await renderPage(currentPageNum);
      } catch (error) {
        console.error('Error loading PDF:', error.message);
        alert(`Failed to load PDF: ${error.message}. Please try a different file.`);
        drawPlaceholder();
      }
    }

    // Render PDF page
    async function renderPage(pageNum) {
      try {
        const page = await pdfDoc.getPage(pageNum);
        const containerWidth = canvasContainer.clientWidth;
        const viewport = page.getViewport({ scale: 1.0 });
        scale = Math.min(containerWidth / viewport.width, 1.0); // Fallback to 1.0 if invalid
        const scaledViewport = page.getViewport({ scale: scale });

        console.log(`Rendering page ${pageNum}: Canvas=${scaledViewport.width}x${scaledViewport.height}, Scale=${scale}`);

        // Set canvas dimensions
        canvas.width = scaledViewport.width;
        canvas.height = scaledViewport.height;
        canvas.style.width = `${scaledViewport.width}px`;
        canvas.style.height = `${scaledViewport.height}px`;
        canvas.style.display = 'block';

        // Clear and render PDF
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const renderContext = { 
          canvasContext: ctx, 
          viewport: scaledViewport 
        };
        await page.render(renderContext).promise;

        // Update Fabric.js canvas after PDF rendering
        fabricCanvas.setDimensions({ 
          width: scaledViewport.width, 
          height: scaledViewport.height 
        });
        fabricCanvas.clear();
        fabricCanvas.renderAll();

        console.log(`Page ${pageNum} rendered successfully`);
      } catch (error) {
        console.error('Error rendering page:', error.message);
        alert(`Failed to render PDF page: ${error.message}`);
        drawPlaceholder();
      }
    }

    // Enable toolbar controls
    function enableControls() {
      addTextBtn.disabled = false;
      fontSelect.disabled = false;
      fontSizeInput.disabled = false;
      pageSizeSelect.disabled = false;
      downloadBtn.disabled = false;
    }

    // Remove selected text from canvas
    function removeSelectedText() {
      const activeObject = fabricCanvas.getActiveObject();
      if (activeObject && activeObject.type === 'i-text') {
        fabricCanvas.remove(activeObject);
        fabricCanvas.renderAll();
        console.log('Selected text removed');
        removeSelectedTextBtn.disabled = true;
      } else {
        console.log('No text selected for removal');
        alert('Please select a text annotation to remove.');
      }
    }

    // Update Remove Selected Text button state based on selection
    fabricCanvas.on('selection:created', () => {
      const activeObject = fabricCanvas.getActiveObject();
      removeSelectedTextBtn.disabled = !(activeObject && activeObject.type === 'i-text');
    });
    fabricCanvas.on('selection:cleared', () => {
      removeSelectedTextBtn.disabled = true;
    });

    // Add text annotation
    addTextBtn.addEventListener('click', () => {
      const text = new fabric.IText('Edit me', {
        left: 50,
        top: 50,
        fontFamily: fontSelect.value,
        fontSize: parseInt(fontSizeInput.value),
        fill: '#000000'
      });
      fabricCanvas.add(text);
      fabricCanvas.setActiveObject(text);
      fabricCanvas.renderAll();
    });

    // Upload PDF
    pdfUpload.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (file && file.type === 'application/pdf') {
        console.log('Uploading PDF:', file.name);
        await loadPDF(file);
      } else {
        console.error('Invalid file type. Please upload a PDF.');
        alert('Please upload a valid PDF file.');
        drawPlaceholder();
      }
    });

    // Resize page
    pageSizeSelect.addEventListener('change', async () => {
      try {
        const size = pageSizeSelect.value;
        const [width, height] = pageSizes[size];
        const pdfDocLib = await PDFLib.PDFDocument.load(pdfBytes);
        const pages = pdfDocLib.getPages();
        pages.forEach(page => {
          page.setSize(width, height);
        });
        pdfBytes = await pdfDocLib.save();
        pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
        await renderPage(currentPageNum);
        console.log(`Page resized to ${size}`);
      } catch (error) {
        console.error('Error resizing page:', error);
        alert('Failed to resize page.');
      }
    });

    // Remove selected text button
    removeSelectedTextBtn.addEventListener('click', () => {
      removeSelectedText();
    });

    // Download modified PDF
    downloadBtn.addEventListener('click', async () => {
      try {
        const pdfDocLib = await PDFLib.PDFDocument.load(pdfBytes);
        const fabricObjects = fabricCanvas.getObjects();
        for (const obj of fabricObjects) {
          if (obj.type === 'i-text') {
            const page = pdfDocLib.getPage(currentPageNum - 1);
            const font = await pdfDocLib.embedFont(PDFLib.StandardFonts[obj.fontFamily.replace('-', '')]);
            page.drawText(obj.text, {
              x: obj.left * scale,
              y: page.getHeight() - (obj.top + obj.fontSize) * scale,
              size: obj.fontSize * scale,
              font: font,
              color: PDFLib.rgb(0, 0, 0)
            });
          }
        }
        const pdfBytesModified = await pdfDocLib.save();
        const blob = new Blob([pdfBytesModified], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'edited.pdf';
        a.click();
        URL.revokeObjectURL(url);
        console.log('PDF downloaded successfully');
      } catch (error) {
        console.error('Error downloading PDF:', error);
        alert('Failed to download PDF.');
      }
    });
  </script>
</body>
</html>
